<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Evaluation vue js/version ajax</title>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    </head>
    <body>
        <div id="app">
            <div v-html='h1'></div>
            <div v-html='date'></div>
            <table>
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Designation</th>
                        <th>Qte</th>
                        <th>Pu Ht</th>
                        <th>Tva</th>
                        <th>P Ht</th>
                        <th>P Ttc</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr @keyup.enter="ajout_element" v-for='value in table' :key='value.id'>
                        <td>{{value.id}}</td>
                        <td><input @input="update(value)" type="text" v-model="value.designation"></td>
                        <td><input @input="update(value)" type="number" min="0" v-model="value.qte"></td>
                        <td><input min="0" @input="update(value)" type="number" v-model="value.pu_ht"></td>
                        <td><input @input="update(value)" type="number" max="100" min="0" v-model="value.tva"></td>
                        <td>{{value.p_ht}}€</td>
                        <td>{{value.p_ttc}}€</td>
                        <td><button @click="_delete(value)"><img src="img/trash.svg" alt="supprimer"></button></td>
                    </tr>
                </tbody>
            </table>
            <div><h2>Total HT : {{tot_ht}} €</h2></div>
            <div><h2>Total TTC : {{tot_ttc}} €</h2></div><br>

            <div><button @click.prevent="ajout_element" >+ Ajouter une ligne</button></div><br>

            <div>Debug {{ table }}</div>

        </div>
        <script>

            var app = new Vue({
                el: '#app',
                data: function (){
                    return {
                        table: [],
                        h1:'<h1>Evaluation VueJs</h1>',
                        date: '<h2>Facture du 5 Décembre 2019<h2>',
                        tot_ht: null,
                        tot_ttc: null,
                        apiUri: "http://localhost:3000/"
                    };
                },

                methods : {
                    ajout_element : function (){
                        fetch(this.apiUri + 'factures/', {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: ""
                        }).then( (data) => { return data.json();
                                           }).then( (data) => {
                            this.table.push(data);
                            this.$nextTick(() => {
                                if (this.table.length != 0) 
                                    document.getElementsByTagName('tr')[this.table.length].getElementsByTagName('input')[0].focus();
                            });
                        });
                    },

                    calcul_prix(){
                        let tot_ht = 0;
                        let tot_ttc = 0;
                        this.table.forEach( (element) =>{
                            if (element.p_ht != undefined)
                                tot_ht += parseFloat(element.p_ht);
                            if (element.p_ttc != undefined)
                                tot_ttc += parseFloat(element.p_ttc);
                        });
                        this.tot_ht = tot_ht.toFixed(2);
                        this.tot_ttc = tot_ttc.toFixed(2);
                    },

                    _delete: function(value){
                        fetch(this.apiUri + 'factures/' + value.id, {
                            method: "DELETE"
                        }).then( (data) => {
                            this.table.splice(this.table.indexOf(value),1);
                            this.calcul_prix();
                        })
                    },

                    update : function (value){
                        if (value.pu_ht >= 0 && value.qte >=0 && (value.tva == undefined || (value.tva >= 0  && value.tva <= 100)) ){

                            value.p_ht = eval(value.pu_ht*value.qte).toFixed(2);
                            value.p_ttc = eval((value.pu_ht*value.qte)+(value.pu_ht*value.qte)*((value.tva== undefined)?0:value.tva)/100).toFixed(2);
                        }

                        fetch(this.apiUri + 'factures/' + value.id, {
                            method: 'PATCH',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(value)
                        });
                        this.calcul_prix();
                    }
                },

                mounted(){
                    fetch(this.apiUri + 'factures/', {
                        method: 'GET',
                    }).then((response) =>{
                        return response.json();
                    })
                        .then( (data) => {
                        this.table = data;
                        this.calcul_prix();
                    });
                },

            });
        </script>
    </body>
</html>